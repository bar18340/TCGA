<!--
  TCGA Data Merger Tool - Web Interface

  This HTML template provides the user interface for uploading, validating, and processing TCGA data files
  via the Flask web application. It supports methylation, gene mapping, gene expression, and phenotype files,
  and allows users to configure cleaning and output options.

  Key Features:
  - Modern drag-and-drop file upload with visual feedback
  - Dynamic phenotype characteristic selection (AJAX preview of columns)
  - Cleaning options (zero-value row threshold with visual slider)
  - Output folder and filename configuration
  - CSV/Excel format selection with recommendations
  - Toast notifications for errors and info
  - Success modal for completed processing
  - Integrates with desktop app for folder picking (if available)

  Notes:
  - Uses Bootstrap 5 for modals and toasts
  - Custom modern CSS for enhanced visual design
  - JavaScript handles drag-and-drop, AJAX preview, and validations
  - The form submits to the Flask '/' route for processing
  - Output results are displayed in a modal dialog
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Merger Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <!-- Header -->
  <div class="app-header">
    <div class="header-content">
      <div class="logo-section">
        <span class="logo-icon">üß¨</span>
        <h1>Data Merger Tool</h1>
      </div>
      <div class="header-subtitle">Process and merge your genomic data files with ease</div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050; margin-top: 80px;">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
              <div class="toast-header bg-{{ 'danger' if category == 'error' else category }} text-white">
                <strong class="me-auto">{{ '‚ùå Error' if category == 'error' else '‚úÖ Success' if category == 'success' else '‚ÑπÔ∏è Info' }}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
              <div class="toast-body">
                {{ message }}
              </div>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>

    <form action="/" method="POST" enctype="multipart/form-data" onsubmit="return showLoading()">
      
      <!-- Step 1: Upload Files Section -->
      <div class="content-section upload-section" id="uploadSection">
        <div class="section-header">
          <h2 class="section-title">
            <span class="section-icon">üìÅ</span>
            Upload Input Files
          </h2>
          <p class="section-description">Drag and drop your files or click to browse</p>
        </div>
        
        <div class="files-grid">
          <!-- Methylation File -->
          <div class="file-card">
            <div class="file-card-header">
              <span class="file-type-icon">üß™</span>
              <div class="file-info">
                <h4 class="file-type-name">Methylation File</h4>
                <span class="file-requirement">Required with Gene Mapping</span>
              </div>
            </div>
            <div class="file-drop-zone" id="methylation-drop">
              <input type="file" name="methylation_file" id="methylation-file" class="file-input-hidden">
              <div class="drop-zone-content">
                <svg class="upload-icon" width="40" height="40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="drop-text">Drop file here or <span class="browse-link">browse</span></p>
                <p class="file-name" id="methylation-name">No file selected</p>
              </div>
            </div>
          </div>

          <!-- Gene Mapping File -->
          <div class="file-card">
            <div class="file-card-header">
              <span class="file-type-icon">üó∫Ô∏è</span>
              <div class="file-info">
                <h4 class="file-type-name">Gene Mapping for Methylation Data</h4>
                <span class="file-requirement">Required with Methylation</span>
              </div>
            </div>
            <div class="file-drop-zone" id="mapping-drop">
              <input type="file" name="mapping_file" id="mapping-file" class="file-input-hidden">
              <div class="drop-zone-content">
                <svg class="upload-icon" width="40" height="40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="drop-text">Drop file here or <span class="browse-link">browse</span></p>
                <p class="file-name" id="mapping-name">No file selected</p>
              </div>
            </div>
          </div>

          <!-- Gene Expression File -->
          <div class="file-card">
            <div class="file-card-header">
              <span class="file-type-icon">üìä</span>
              <div class="file-info">
                <h4 class="file-type-name">Gene Expression File</h4>
                <span class="file-requirement">Optional</span>
              </div>
            </div>
            <div class="file-drop-zone" id="expression-drop">
              <input type="file" name="expression_file" id="expression-file" class="file-input-hidden">
              <div class="drop-zone-content">
                <svg class="upload-icon" width="40" height="40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="drop-text">Drop file here or <span class="browse-link">browse</span></p>
                <p class="file-name" id="expression-name">No file selected</p>
              </div>
            </div>
          </div>

          <!-- Phenotype File -->
          <div class="file-card">
            <div class="file-card-header">
              <span class="file-type-icon">üë•</span>
              <div class="file-info">
                <h4 class="file-type-name">Phenotype File</h4>
                <span class="file-requirement">Optional</span>
              </div>
            </div>
            <div class="file-drop-zone" id="phenotype-drop">
              <input type="file" name="phenotype_file" id="phenotype-file" class="file-input-hidden">
              <div class="drop-zone-content">
                <svg class="upload-icon" width="40" height="40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="drop-text">Drop file here or <span class="browse-link">browse</span></p>
                <p class="file-name" id="phenotype-name">No file selected</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Phenotype Selection (appears when file is uploaded) -->
        <div class="phenotype-selection" id="phenotypeSelectWrapper" style="display: none;">
          <label class="selection-label">Select Phenotype Characteristics</label>
          <select name="phenos" id="phenotypeSelect" class="form-select modern-select" multiple size="5"></select>
          <small class="form-text">Hold Ctrl (Windows) or Cmd (Mac) to select multiple</small>
        </div>
      </div>

      <!-- Step 2: Configuration Section -->
      <div class="content-section config-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="section-icon">‚öôÔ∏è</span>
            Configuration
          </h2>
        </div>

        <div class="config-grid">
          <!-- Output Settings -->
          <div class="config-card">
            <h3 class="config-title">Output Settings</h3>
            
            <div class="form-group">
              <label class="form-label">Save To Folder</label>
              <div class="input-with-button">
                <input type="text" id="saveFolder" name="save_folder" class="modern-input" readonly required placeholder="Select output folder...">
                <button type="button" class="browse-btn" onclick="pickFolder()">
                  <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                  </svg>
                  Browse
                </button>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Output File Name</label>
              <input type="text" name="output_filename" placeholder="e.g., merged_data" class="modern-input">
              <small class="form-text">Leave empty for default name</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">Output Format</label>
              <div class="format-options">
                <label class="format-option selected">
                  <input type="radio" name="output_format" value="csv" checked>
                  <div class="format-card-modern">
                    <span class="format-icon">üìÑ</span>
                    <span class="format-name">CSV</span>
                    <span class="format-badge">Recommended</span>
                  </div>
                </label>
                <label class="format-option">
                  <input type="radio" name="output_format" value="excel">
                  <div class="format-card-modern">
                    <span class="format-icon">üìä</span>
                    <span class="format-name">Excel</span>
                    <span class="format-badge-placeholder">&nbsp;</span>
                  </div>
                </label>
              </div>
              <div class="format-tip">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"></path>
                </svg>
                CSV format is faster and handles large files better
              </div>
            </div>
          </div>

          <!-- Processing Options -->
          <div class="config-card">
            <h3 class="config-title">Processing Options</h3>
            
            <div class="form-group">
              <label class="form-label">
                Clean rows with % of zeros
                <span class="value-display" id="zeroValue">100</span>%
              </label>
              <div class="slider-wrapper">
                <span class="slider-label">0%</span>
                <input type="range" id="zeroSlider" class="modern-slider" min="0" max="100" step="1" value="100">
                <span class="slider-label">100%</span>
              </div>
              <input type="hidden" name="zero_threshold" id="zeroInput" value="100">
              <small class="form-text">Removes rows where zero values meet or exceed this threshold</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-section">
        <button type="button" class="btn-secondary-modern" onclick="window.location.href='/reset'">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Reset
        </button>
        <button type="submit" id="runButton" class="btn-primary-modern">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V2"></path>
          </svg>
          Process & Save Data
        </button>
      </div>
      
      <!-- Loading Overlay -->
      <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-modal">
          <div class="loading-icon">
            <div class="spinner"></div>
          </div>
          <h3 class="loading-title">Processing Your Data</h3>
          <p class="loading-text">Please wait while we merge and clean your files...</p>
          <div class="progress-modern">
            <div id="progressBar" class="progress-bar-modern"></div>
          </div>
          <p class="loading-tip">This may take a few moments for large files</p>
        </div>
      </div>
      
      <!-- Success Modal -->
      {% if success and outputs %}
      <div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content modern-modal">
            <div class="modal-body text-center p-4">
              <div class="success-icon">
                <svg width="60" height="60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h3 class="modal-title mb-3">Files Processed Successfully!</h3>
              <p class="text-muted mb-4">Your merged data has been saved to:</p>
              <div class="output-list">
                {% for out in outputs %}
                  <div class="output-item">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-5L9 2H4z"></path>
                    </svg>
                    {{ out.label }}
                  </div>
                {% endfor %}
              </div>
              <a href="/reset" class="btn-primary-modern mt-4">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Start New Analysis
              </a>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </form>
  </div>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- JavaScript -->
  <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>