<!--
  TCGA Data Merger Tool - Main Web Interface

  This HTML template provides the user interface for uploading, validating, and processing TCGA data files
  via the Flask web application. It supports methylation, gene mapping, gene expression, and phenotype files,
  and allows users to configure cleaning and output options.

  Key Features:
  - File upload fields for all supported TCGA data types.
  - Dynamic phenotype characteristic selection (AJAX preview of columns).
  - Cleaning options (zero-value row threshold).
  - Output folder and filename configuration.
  - Displays user feedback and error messages using Bootstrap alerts.
  - Shows download/output links for processed files.
  - Integrates with desktop app for folder picking (if available).

  Notes:
  - Uses Bootstrap 5 for styling and layout.
  - JavaScript handles AJAX preview of phenotype columns and folder picking.
  - The form submits to the Flask '/' route for processing.
  - Output links and messages are rendered based on Flask context variables.
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TCGA Data Merger</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
<div class="container">
  <h1 class="text-center text-primary mb-4">üß¨ TCGA Data Merger Tool</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-danger text-center">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form action="/" method="POST" enctype="multipart/form-data" onsubmit="showLoading()">
    <div class="row justify-content-center">
      <div class="col-md-8">

        <!-- Upload Input Files -->
        <div class="rounded-box">
          <h5 class="text-center">Upload Input Files</h5>
          <div class="mb-3">
            <label class="form-label">Methylation File</label>
            <input type="file" name="methylation_file" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Gene Mapping File</label>
            <input type="file" name="mapping_file" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Gene Expression File</label>
            <input type="file" name="expression_file" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Phenotype File</label>
            <input type="file" name="phenotype_file" id="phenotypeFile" class="form-control">
          </div>

          <!-- Dynamic phenotype selection -->
          <div class="mb-3" id="phenotypeSelectWrapper" style="display: none;">
            <label class="form-label">Select Phenotype Characteristics</label>
            <select name="phenos" id="phenotypeSelect" class="form-select" multiple></select>
            <small class="form-text text-muted">
              Hold Ctrl (Windows) or Cmd (Mac) to select multiple.
            </small>
          </div>
        </div>

        <!-- Cleaning Settings -->
        <div class="rounded-box">
          <h5 class="text-center">Options</h5>
          <div class="mb-3">
            <label class="form-label">Clean rows with % of zeros (0 ‚Äì 100)</label>
            <input type="number" name="zero_threshold" value="100" class="form-control text-center" min="0" max="100">
          </div>
          <div class="mb-3">
            <label class="form-label">Save To Folder</label>
            <div class="input-group">
              <input type="text" id="saveFolder" name="save_folder" class="form-control" readonly>
              <button type="button" class="btn btn-outline-secondary" onclick="pickFolder()">Browse</button>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Output File Name (without extension)</label>
            <input type="text" name="output_filename" placeholder="e.g., merged_data" class="form-control">
            <small class="form-text text-muted">If left empty, will use default name.</small>
          </div>
        </div>

        <!-- Submit Buttons -->
        <div class="text-center mt-3">
          <button type="submit" id="runButton" class="btn btn-green btn-lg me-3">üíæ Save Merged Data</button>
          <a href="/reset" class="btn btn-red btn-lg">Reset</a>
        </div>
        <div id="loadingIndicator" class="text-center mt-4" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2"><strong>Processing files, please wait...</strong><br>This may take a moment for large files.</p>
        </div>
         <!-- Output Links -->
        {% if success and outputs %}
          <div class="alert alert-success mt-4 text-center">
            <h5>‚úÖ Output CSV Files Saved</h5>
            <ul class="list-unstyled">
              {% for out in outputs %}
                <li>{{ out.label }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </div>
    </div>
  </form>
</div>

<script>
  /*
  JavaScript for folder picking (desktop app) and dynamic phenotype column preview.

  - pickFolder(): Uses pywebview API to select a folder if running as a desktop app.
  - Phenotype file input triggers AJAX POST to /preview_phenotype, populating the phenotype select box.
*/
function pickFolder() {
  if (window.pywebview) {
    window.pywebview.api.select_folder().then(function(result) {
      if (result && result.length > 0) {
        document.getElementById("saveFolder").value = result[0];
      }
    });
  } else {
    alert("Folder picker is only available in the desktop app.");
  }
}

document.getElementById('phenotypeFile').addEventListener('change', function (event) {
  const fileInput = event.target;
  const file = fileInput.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append('phenotype_file', file);

  fetch('/preview_phenotype', {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    const selectWrapper = document.getElementById('phenotypeSelectWrapper');
    const select = document.getElementById('phenotypeSelect');
    select.innerHTML = '';

    if (data.error) {
      alert('‚ö†Ô∏è Error reading phenotype file: ' + data.error);
      return;
    }

    data.columns.forEach(col => {
      const option = document.createElement('option');
      option.value = col;
      option.textContent = col;
      select.appendChild(option);
    });

    selectWrapper.style.display = 'block';
  })
  .catch(err => {
    alert('‚ö†Ô∏è Could not load phenotype characteristics.');
    console.error(err);
  });
});
</script>
<script>
  function showLoading() {
    // Get the button and the spinner div
    const runButton = document.getElementById('runButton');
    const loadingIndicator = document.getElementById('loadingIndicator');

    // Show the spinner and disable the button to prevent multiple clicks
    loadingIndicator.style.display = 'block';
    runButton.disabled = true;
    runButton.innerHTML = 'üíæ Processing...';

    // Allow the form to submit
    return true;
  }
</script>
</body>
</html>
